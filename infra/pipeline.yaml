AWSTemplateFormatVersion: '2010-09-09'
Description: 'CodePipeline: per-service ECS deploy (GitHub via CodeStar, CodeBuild builds image, CFN deploys ECS stack)'

Parameters:
  # ---------------- Pipeline.sh åˆ›å»ºæ—¶ä¼ å…¥ ----------------
  ArtifactBucketName:     # ğŸ”µ å…±äº« S3 æ¡¶ï¼ˆPipeline.sh ä¼ å…¥ï¼‰
    Type: String
    Description: 'å·²å­˜åœ¨çš„ S3 æ¡¶åï¼ˆPipeline Artifacts å­˜æ”¾å¤„ï¼‰'

  PipelineName:           # ğŸ”µ ç”± pipeline.sh æ ¹æ® --service è‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚ deploy-demo-user-rpc
    Type: String

  CFNDeployRoleArn:       # ğŸ”µ CloudFormation éƒ¨ç½²è§’è‰²ï¼ˆç”± pipeline.sh ä¼ å…¥ï¼‰
    Type: String

  ConnectionArn:          # ğŸ”µ CodeStar Connection ARNï¼ˆç”± pipeline.sh ä¼ å…¥ï¼‰
    Type: String

  FullRepo:               # ğŸ”µ GitHub ä»“åº“ï¼ˆorg/repoï¼‰ï¼ˆç”± pipeline.sh ä¼ å…¥ï¼‰
    Type: String

  BranchName:             # ğŸ”µ ä»“åº“åˆ†æ”¯ï¼ˆç”± pipeline.sh ä¼ å…¥ï¼‰
    Type: String
    Default: 'main'

  ServiceName:            # ğŸ”µ æœåŠ¡åï¼ˆç”± pipeline.sh ä¼ å…¥ï¼Œå¦‚ demo-user-rpcï¼‰
    Type: String

  SdServiceId:            # ğŸ”µ Cloud Map Service IDï¼ˆç”± pipeline.sh ä¼ å…¥ï¼Œå¦‚ srv-xxxxxxï¼‰
    Type: String

  TemplatePath:           # ğŸ”µ ECS CFN æ¨¡æ¿è·¯å¾„ï¼ˆåœ¨æºç ä»“åº“å†…ï¼Œå¦‚ ci/ecs-service-deploy.yamlï¼‰
    Type: String
    Default: 'ci/ecs-service-deploy.yaml'

  # ---------------- å¯é€‰å‚æ•°ï¼Œç”±æ¨¡æ¿å†…éƒ¨è‡ªåŠ¨æ´¾ç”Ÿ ----------------
  EcrRepositoryUri:       # ğŸŸ¢ å¯é€‰ã€‚å¦‚æœæœªä¼ ï¼Œæ¨¡æ¿ä¼šè‡ªåŠ¨æ‹¼å‡º ECR repoï¼ˆæŒ‰ ServiceNameï¼‰
    Type: String
    Default: ""

  ImageTagFormat:         # ğŸ”µ æˆ–ç”± pipeline.sh ä¼ å…¥ï¼ˆé»˜è®¤ commit8ï¼‰
    Type: String
    AllowedValues: ['commit8','timestamp','latest']
    Default: 'commit8'

  # ---------------- å…¨å±€é»˜è®¤å‚æ•°ï¼ˆå…±ç”¨åŸºç¡€é…ç½®ï¼‰ ----------------
  ClusterName:            # ğŸŸ¡ ECS Cluster åç§°ï¼ˆé»˜è®¤å³å¯ï¼‰
    Type: String
    Default: 'demo-cluster'
  ExecutionRoleArn:
    Type: String
    Default: 'arn:aws:iam::297997107448:role/ecsTaskExecutionRole'
  TaskRoleArn:
    Type: String
    Default: 'arn:aws:iam::297997107448:role/ecsTaskRole'
  Subnets:
    Type: String
    Default: 'subnet-02c0811a961e428b5,subnet-0d3bc6916292f848c'
  SecurityGroups:
    Type: String
    Default: 'sg-00a34a14c1889ddfc'
  AssignPublicIp:
    Type: String
    AllowedValues: ['ENABLED','DISABLED']
    Default: 'ENABLED'
  LogStreamPrefix:
    Type: String
    Default: 'ecs'

Conditions:
  UseProvidedRepo: !Not [ !Equals [ !Ref EcrRepositoryUri, "" ] ]

# ---------------------------------------------------------------------------
# Resources
# ---------------------------------------------------------------------------
Resources:
  # ================= IAM: CodePipeline Role =================
  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${PipelineName}-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: codepipeline.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: 'pipeline-inline'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: S3Artifacts
                Effect: Allow
                Action: [ s3:GetObject, s3:GetObjectVersion, s3:PutObject, s3:ListBucket ]
                Resource:
                  - !Sub 'arn:aws:s3:::${ArtifactBucketName}'
                  - !Sub 'arn:aws:s3:::${ArtifactBucketName}/*'
              - Sid: CodeStarConn
                Effect: Allow
                Action: [ codestar-connections:UseConnection ]
                Resource: !Ref ConnectionArn
              - Sid: CodeBuildStart
                Effect: Allow
                Action: [ codebuild:BatchGetBuilds, codebuild:StartBuild ]
                Resource: '*'
              - Sid: CloudFormationCtl
                Effect: Allow
                Action:
                  - cloudformation:*
                Resource: '*'
              - Sid: AssumeCFNDeployRole
                Effect: Allow
                Action: sts:AssumeRole
                Resource: !Ref CFNDeployRoleArn
              - Sid: PassTaskRoles
                Effect: Allow
                Action: iam:PassRole
                Resource:
                  - !Ref ExecutionRoleArn
                  - !Ref TaskRoleArn

  # ================= IAM: CodeBuild Role =================
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${PipelineName}-build-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: codebuild.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: 'codebuild-inline'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: Logs
                Effect: Allow
                Action: [ logs:* ]
                Resource: '*'
              - Sid: S3Artifacts
                Effect: Allow
                Action: [ s3:* ]
                Resource:
                  - !Sub 'arn:aws:s3:::${ArtifactBucketName}'
                  - !Sub 'arn:aws:s3:::${ArtifactBucketName}/*'
              - Sid: ECRReadWrite
                Effect: Allow
                Action: [ ecr:* ]
                Resource: '*'

  # ================= CodeBuild Project =================
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${PipelineName}-build'
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        Image: 'aws/codebuild/standard:7.0'
        ComputeType: BUILD_GENERAL1_SMALL
        PrivilegedMode: true
        EnvironmentVariables:
          # ğŸ”´ ä¸‹å‘ç»™ buildspec.yaml çš„å˜é‡ï¼ˆç”± pipeline.yaml æ§åˆ¶ï¼‰
          - Name: ECR_REPO_URI
            Type: PLAINTEXT
            Value: !If
              - UseProvidedRepo
              - !Ref EcrRepositoryUri
              - !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ServiceName}'
          - Name: IMAGE_TAG_FORMAT
            Type: PLAINTEXT
            Value: !Ref ImageTagFormat
      Source:
        Type: CODEPIPELINE
        BuildSpec: 'ci/buildspec.yaml'
      TimeoutInMinutes: 60

  # ================= CodePipeline =================
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Ref PipelineName
      RoleArn: !GetAtt CodePipelineServiceRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucketName

      Variables:   # âœ… pipeline-level è¿è¡Œæ—¶å˜é‡ï¼Œå¯åœ¨ start-pipeline-execution ä¸­è¦†ç›–
        - Name: LANE
          DefaultValue: 'default'
        - Name: DESIRED
          DefaultValue: '1'
        - Name: CONT_PORT
          DefaultValue: '8080'

      Stages:
        # -------- Source --------
        - Name: Source
          Actions:
            - Name: GitHubSource
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              Configuration:
                ConnectionArn: !Ref ConnectionArn
                FullRepositoryId: !Ref FullRepo
                BranchName: !Ref BranchName
                OutputArtifactFormat: CODE_ZIP
                DetectChanges: true
              OutputArtifacts:
                - Name: SourceOut

        # -------- Build --------
        - Name: Build
          Actions:
            - Name: DockerBuild
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref CodeBuildProject
              InputArtifacts:
                - Name: SourceOut
              OutputArtifacts:
                - Name: BuildOut

        # -------- Deploy --------
        - Name: Deploy
          Actions:
            - Name: CFNDeploy
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: SourceOut
                - Name: BuildOut
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub '${ServiceName}-#{variables.LANE}'
                TemplatePath: !Sub 'SourceOut::${TemplatePath}'
                TemplateConfiguration: 'BuildOut::cfn-params.json'
                RoleArn: !Ref CFNDeployRoleArn
                Capabilities: 'CAPABILITY_IAM,CAPABILITY_NAMED_IAM'
                ParameterOverrides:
                  !Sub
                  - |
                    {
                      "ServiceBase": "${ServiceName}",
                      "Lane": "#{variables.LANE}",
                      "ClusterName": "${ClusterName}",
                      "ExecutionRoleArn": "${ExecutionRoleArn}",
                      "TaskRoleArn": "${TaskRoleArn}",
                      "Subnets": "${Subnets}",
                      "SecurityGroups": "${SecurityGroups}",
                      "AssignPublicIp": "${AssignPublicIp}",
                      "LogStreamPrefix": "${LogStreamPrefix}",
                      "ContainerPort": "#{variables.CONT_PORT}",
                      "DesiredCount": "#{variables.DESIRED}",
                      "SdRegistryArn": "${SdArnResolved}"
                    }
                  - { SdArnResolved: !Sub 'arn:aws:servicediscovery:${AWS::Region}:${AWS::AccountId}:service/${SdServiceId}' }

      RestartExecutionOnUpdate: true

Outputs:
  PipelineNameOut:
    Value: !Ref PipelineName
  CodeBuildProjectOut:
    Value: !Ref CodeBuildProject