AWSTemplateFormatVersion: '2010-09-09'
Description: 'CodePipeline: per-service ECS deploy (GitHub via CodeStar, CodeBuild builds image, CFN deploys ECS stack)'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: { default: "âœ… å¿…å¡«å‚æ•°ï¼ˆå¿…é¡»æä¾›ï¼‰" }
        Parameters:
          - PipelineName
          - ServiceName
          - SdServiceId
          - RepoName
      - Label: { default: "ğŸ§© é€‰å¡«å‚æ•°ï¼ˆæœ‰é»˜è®¤å€¼ï¼Œå¯è¦†ç›–ï¼‰" }
        Parameters:
          - ConnectionArn
          - ArtifactBucketName
          - CloudFormationDeployRoleArn
          - CodePipelineRoleArn
          - CodeBuildRoleArn
          - BranchName
          - TemplatePath
          - ImageTagFormat
          - EcrRepositoryUri
          - ClusterName
          - ExecutionRoleArn
          - TaskRoleArn
          - Subnets
          - SecurityGroups
          - AssignPublicIp
          - LaneName
          - ContainerPort
    ParameterLabels:
      PipelineName: { default: "Pipeline åç§°" }
      ServiceName: { default: "æœåŠ¡åï¼ˆServiceBaseï¼‰" }
      SdServiceId: { default: "Cloud Map Service ID" }
      RepoName: { default: "GitHub ä»“åº“ï¼ˆorg/repoï¼‰" }
      ConnectionArn: { default: "CodeStar Connections ARN" }
      ArtifactBucketName: { default: "å­˜å‚¨Artifactsçš„ S3 æ¡¶" }
      LaneName: { default: "æ³³é“ç¯å¢ƒæ ‡ç­¾" }
      ContainerPort: { default: "é»˜è®¤å®¹å™¨ç«¯å£" }

Parameters:

  # =========================================================
  # âœ… å¿…å¡«å‚æ•°ï¼ˆæ— é»˜è®¤å€¼ï¼Œå¿…é¡»ä¼ å…¥ï¼‰
  # =========================================================

  # --- æœåŠ¡åŸºç¡€ä¿¡æ¯ ---
  PipelineName:
    Type: String
    Description: 'Pipeline åç§°ï¼ˆä¾‹å¦‚ deploy-<service>ï¼‰'

  ServiceName:
    Type: String
    Description: 'æœåŠ¡åï¼ˆ= ServiceBaseï¼Œä¾‹å¦‚ demo-user-rpcï¼‰'

  SdServiceId:
    Type: String
    Description: 'Cloud Map Service IDï¼ˆå¦‚ srv-xxxxxxï¼‰'

  RepoName:
    Type: String
    Description: 'GitHub ä»“åº“å…¨åï¼ˆorg/repoï¼‰'

  # =========================================================
  # ğŸ§© é€‰å¡«å‚æ•°ï¼ˆæœ‰é»˜è®¤å€¼ï¼Œå¯è¦†ç›–ï¼‰
  # =========================================================

  # --- æºç æ¥æºï¼ˆGitHub via CodeStar Connectionsï¼‰---
  ConnectionArn:
    Type: String
    Default: 'arn:aws:codeconnections:us-east-1:297997107448:connection/9adfd918-2843-4147-9bc9-c4ee1a99bc39'
    Description: 'CodeStar Connections ARNï¼ˆGitHub è¿æ¥ï¼‰'

  ArtifactBucketName:
    Type: String
    Default: 'codepipeline-us-east-1-3622cd43956e-4d23-9284-a18746ff6c07'
    Description: 'å­˜æ”¾Pipeline Artifactsçš„S3æ¡¶å'

  # --- å›ºå®šè§’è‰² ---
  CloudFormationDeployRoleArn:
    Type: String
    Default: 'arn:aws:iam::297997107448:role/CloudFormationDeployRole'
    Description: 'CloudFormation æ‰§è¡Œè§’è‰² ARNï¼ˆç”± CodePipeline çš„ CFN Action å‡è®¾ï¼‰'

  CodePipelineRoleArn:
    Type: String
    Default: 'arn:aws:iam::297997107448:role/CodePipelineRole'
    Description: 'CodePipeline Service Role ARN'

  CodeBuildRoleArn:
    Type: String
    Default: 'arn:aws:iam::297997107448:role/CodeBuildRole'
    Description: 'CodeBuild Service Role ARN'

  # --- æºç ä¸æ¨¡æ¿ ---
  BranchName:
    Type: String
    Default: 'main'
    Description: 'Git åˆ†æ”¯åï¼ˆé»˜è®¤ mainï¼‰'

  TemplatePath:
    Type: String
    Default: 'ci/ecs-service-deploy.yaml'
    Description: 'ä»“åº“å†…çš„ ECS éƒ¨ç½²æ¨¡æ¿è·¯å¾„ï¼ˆéšæºç æ‰“åŒ…ï¼‰'

  # --- é•œåƒæ„å»ºé…ç½® ---
  ImageTagFormat:
    Type: String
    AllowedValues: [ 'commit8','timestamp','latest','fixed' ]
    Default: 'commit8'
    Description: "é•œåƒ Tag ç”Ÿæˆç­–ç•¥ï¼šcommit8 / timestamp / latest / fixedï¼›buildspec å°†æŒ‰æ­¤è§„åˆ™ç”Ÿæˆ tag"

  EcrRepositoryUri:
    Type: String
    Default: ''
    Description: "ï¼ˆå¯é€‰ï¼‰æ˜¾å¼æŒ‡å®š ECR Repo URIï¼›ç•™ç©ºåˆ™æŒ‰ <account>.dkr.ecr.<region>.amazonaws.com/<ServiceName> æ¨å¯¼"

  # --- ECS ç½‘ç»œä¸ä»»åŠ¡æ‰§è¡Œé…ç½® ---
  ClusterName:
    Type: String
    Default: 'demo-cluster'
    Description: 'ECS é›†ç¾¤åç§°'

  ExecutionRoleArn:
    Type: String
    Default: 'arn:aws:iam::297997107448:role/ecsTaskExecutionRole'
    Description: 'ECS ä»»åŠ¡æ‰§è¡Œè§’è‰²ï¼ˆtask execution roleï¼‰'

  TaskRoleArn:
    Type: String
    Default: 'arn:aws:iam::297997107448:role/ecsTaskRole'
    Description: 'ECS å®¹å™¨ä»»åŠ¡è§’è‰²ï¼ˆtask roleï¼‰'

  Subnets:
    Type: String
    Default: 'subnet-02c0811a961e428b5,subnet-0d3bc6916292f848c'
    Description: 'ECS Service ä½¿ç”¨çš„å­ç½‘ ID åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰'

  SecurityGroups:
    Type: String
    Default: 'sg-00a34a14c1889ddfc'
    Description: 'ECS Service å®‰å…¨ç»„ ID åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰'

  AssignPublicIp:
    Type: String
    AllowedValues: [ 'ENABLED','DISABLED' ]
    Default: 'ENABLED'
    Description: 'æ˜¯å¦åˆ†é…å…¬æœ‰ IPï¼ˆé»˜è®¤ ENABLEDï¼‰'


  LaneName:
    Type: String
    Default: 'default'
    Description: 'Pipeline æŒ‡å®šæœåŠ¡æ³³é“æ ‡ç­¾'

  ContainerPort:
    Type: Number
    Default: 8080
    Description: 'Pipeline æŒ‡å®šå®¹å™¨é»˜è®¤ç«¯å£'

Conditions:
  UseProvidedRepo: !Not [ !Equals [ !Ref EcrRepositoryUri, '' ] ]

Resources:

  # ---------------- CodeBuild Projectï¼ˆä½¿ç”¨å›ºå®šRoleï¼‰----------------
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${PipelineName}-build'
      ServiceRole: !Ref CodeBuildRoleArn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        Image: 'aws/codebuild/standard:7.0'
        ComputeType: BUILD_GENERAL1_SMALL
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: ECR_REPO_URI
            Type: PLAINTEXT
            Value: !If
              - UseProvidedRepo
              - !Ref EcrRepositoryUri
              - !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ServiceName}'
          - Name: IMAGE_TAG_FORMAT
            Type: PLAINTEXT
            Value: !Ref ImageTagFormat
      Source:
        Type: CODEPIPELINE
        BuildSpec: 'ci/buildspec.yaml'
      TimeoutInMinutes: 60

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Ref PipelineName
      RoleArn: !Ref CodePipelineRoleArn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucketName

      Variables:
        - Name: LANE
          DefaultValue: !Ref LaneName
        - Name: DESIRED_COUNT
          DefaultValue: '0'
        - Name: CONTAINER_PORT
          DefaultValue: !Ref ContainerPort

      Stages:
        - Name: Source
          Actions:
            - Name: GitHubSource
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              Configuration:
                ConnectionArn: !Ref ConnectionArn
                FullRepositoryId: !Ref RepoName
                BranchName: !Ref BranchName
                OutputArtifactFormat: CODE_ZIP
                DetectChanges: true
              OutputArtifacts:
                - Name: SourceOut

        - Name: Build
          Actions:
            - Name: DockerBuild
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref CodeBuildProject
              InputArtifacts:
                - Name: SourceOut
              OutputArtifacts:
                - Name: BuildOut

        - Name: Deploy
          Actions:
            - Name: CFNDeploy
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: SourceOut
                - Name: BuildOut
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub '${ServiceName}-#{variables.LANE}'
                TemplatePath: !Sub 'SourceOut::${TemplatePath}'
                TemplateConfiguration: 'BuildOut::cfn-params.json'
                RoleArn: !Ref CloudFormationDeployRoleArn
                Capabilities: 'CAPABILITY_IAM,CAPABILITY_NAMED_IAM'
                ParameterOverrides:
                  !Sub
                  - |
                    {
                      "ServiceBase": "${ServiceName}",
                      "Lane": "#{variables.LANE}",
                      "ClusterName": "${ClusterName}",
                      "ExecutionRoleArn": "${ExecutionRoleArn}",
                      "TaskRoleArn": "${TaskRoleArn}",
                      "Subnets": "${Subnets}",
                      "SecurityGroups": "${SecurityGroups}",
                      "AssignPublicIp": "${AssignPublicIp}",
                      "ContainerPort": "#{variables.CONTAINER_PORT}",
                      "DesiredCount": "#{variables.DESIRED_COUNT}",
                      "SdRegistryArn": "${SdArnResolved}"
                    }
                  - { SdArnResolved: !Sub 'arn:aws:servicediscovery:${AWS::Region}:${AWS::AccountId}:service/${SdServiceId}' }

      RestartExecutionOnUpdate: true

Outputs:
  PipelineNameOut:
    Value: !Ref PipelineName
  CodeBuildProjectOut:
    Value: !Ref CodeBuildProject